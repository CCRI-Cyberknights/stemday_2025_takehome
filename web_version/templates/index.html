<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>{{ list_title }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <script>
    window.addEventListener("pageshow", function (event) {
      if (event.persisted) {
        window.location.reload();
      }
    });
  </script>
</head>

<body data-total-challenges="{{ challenges.challenges | length }}"
  data-challenge-ids='{{ challenges.get_list_of_ids() | tojson }}' data-challenge-base-url="{{ url_for('main.index') }}"
  data-mode="{{ mode }}" data-base-mode="{{ base_mode }}">

  <div class="top-right">
    <button onclick="goToLanding();" class="home-btn">üè† Back to Hub</button>
  </div>

  <h1>üöÄ {{ list_title }}</h1>

  {% if mode == 'regular' %}
  <div class="mode-intro guided-intro">
    <h2>üî≠ Exploration Mode Overview</h2>
    <p>
      Exploration Mode is a hands-on demo track. Each challenge has a helper script that
      runs real Linux commands on real files in the challenge folder.
    </p>
    <p>
      Your job is to spot the <strong>one real flag</strong> that matches our standard format:
      <strong>CCRI-AAAA-1111</strong>.
    </p>
  </div>
  {% elif mode == 'solo' %}
  <div class="mode-intro solo-intro">
    <h2>üî• Solo Mode Overview</h2>
    <p>
      Solo Mode is the full investigation experience. There are no helper scripts here ‚Äî
      <strong>you</strong> choose the tools and dig through the data to uncover the flag.
    </p>
    <p>
      Your mission is simple: find the hidden flag in the challenge files and submit it
      in our standard flag format: <strong>CCRI-AAAA-1111</strong>.
    </p>
  </div>
  {% endif %}

  <h2 id="progress-counter" class="progress">
    {{ challenges.completed_challenges | length }} of {{ challenges.challenges | length }} challenges completed
  </h2>

  <div class="grid">
    {% for challenge in challenges.challenges %}
    <div class="challenge-card{% if challenge.complete %} completed{% endif %}" id="{{ challenge.id }}">
      <h3>{{ challenge.ch_number }}. {{ challenge.name }}</h3>
      {% if challenge.complete %}
      <p class="challenge-status">‚úÖ Completed</p>
      {% else %}
      <button class="view-btn" type="button"
        data-challenge-url="{{ url_for('main.challenge_view', challenge_id=challenge.id) }}"
        onclick="startChallenge(this);">
        üöÄ Start Challenge
      </button>
      {% endif %}
    </div>
    {% endfor %}
  </div>

  <script>
    function goToLanding() {
      window.location.href = "{{ url_for('main.landing_page') }}";
    }

    function startChallenge(button) {
      const url = button.dataset.challengeUrl;
      window.location.href = url;
    }

    document.addEventListener("DOMContentLoaded", () => {
      const body = document.body;
      const total = parseInt(body.dataset.totalChallenges);
      const challengeIDs = JSON.parse(body.dataset.challengeIds);
      const storagePrefix = `${body.dataset.baseMode}-${body.dataset.mode}`;
      let completed = 0;

      challengeIDs.forEach((challengeId) => {
        const savedFlag = localStorage.getItem(`${storagePrefix}-${challengeId}`);
        if (savedFlag) {
          const card = document.getElementById(challengeId);
          if (card) {
            card.classList.add("completed");
            completed++;
            const button = card.querySelector("button.view-btn");
            if (button) {
              button.remove();
              const status = document.createElement("p");
              status.className = "challenge-status";
              status.textContent = "‚úÖ Completed";
              card.appendChild(status);
            }
          }
        }
      });
      document.getElementById("progress-counter").textContent =
        `${completed} of ${total} challenges completed`;
    });
  </script>
</body>

</html>