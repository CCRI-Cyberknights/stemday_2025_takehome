<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>{{ list_title }}</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
    <!-- Prevent back/forward cache issues -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <script>
      // Force reload when navigating with browser back/forward buttons
      window.addEventListener("pageshow", function (event) {
        if (event.persisted) {
          console.log("‚è™ Back/Forward cache detected: Reloading index...");
          window.location.reload();
        }
      });
    </script>
  </head>
  <body 
    data-total-challenges="{{ challenges.challenges | length }}"
    data-challenge-ids='{{ challenges.get_list_of_ids() | tojson }}'
    data-challenge-base-url="{{ url_for('index') }}"
    data-mode="{{ mode }}"
    data-base-mode="{{ base_mode }}"
  >
    <!-- üÜï Top-right Back to Hub Button -->
    <div class="top-right">
      <button onclick="goToLanding();" class="home-btn">üè† Back to Hub</button>
    </div>

    <h1>üöÄ {{ list_title }}</h1>
    <p>Welcome to the web hub for solving CTF challenges.</p>
    <p><strong>Flag Format:</strong> CCRI-AAAA-1111</p>

    <h2 id="progress-counter" class="progress">
      {{ challenges.completed_challenges | length }} of {{ challenges.challenges | length }} challenges completed
    </h2>

    <div class="grid">
      {% for challenge in challenges.challenges %}
      <div class="challenge-card{% if challenge.complete %} completed{% endif %}" id="{{ challenge.id }}">
        <h3>{{ challenge.ch_number }}. {{ challenge.name }}</h3>
        {% if challenge.complete %}
        <p class="challenge-status">‚úÖ Completed</p>
        {% else %}
        <button
          class="view-btn"
          type="button"
          data-challenge-url="/challenge/{{ challenge.id }}"
          onclick="startChallenge(this);"
        >
          üöÄ Start Challenge
        </button>
        {% endif %}
      </div>
      {% endfor %}
    </div>

    <script>
      function goToLanding() {
        window.location.href = "/";
      }

      function startChallenge(button) {
        const url = button.dataset.challengeUrl;
        window.location.href = url;
      }

      document.addEventListener("DOMContentLoaded", () => {
        const body = document.body;
        const total = parseInt(body.dataset.totalChallenges);
        const challengeIDs = JSON.parse(body.dataset.challengeIds);

        // Use a mode-specific key for progress tracking
        const storagePrefix = `${body.dataset.baseMode}-${body.dataset.mode}`;
        let completed = 0;

        challengeIDs.forEach((challengeId) => {
          const savedFlag = localStorage.getItem(`${storagePrefix}-${challengeId}`);
          if (savedFlag) {
            const card = document.getElementById(challengeId);
            card.classList.add("completed");
            completed++;

            // Remove the button if it exists
            const button = card.querySelector("button.view-btn");
            if (button) {
              button.remove();

              // Add ‚úÖ Completed label in its place
              const status = document.createElement("p");
              status.className = "challenge-status";
              status.textContent = "‚úÖ Completed";
              card.appendChild(status);
            }
          }
        });

        // Update progress counter
        document.getElementById("progress-counter").textContent =
          `${completed} of ${total} challenges completed`;
      });
    </script>
  </body>
</html>
